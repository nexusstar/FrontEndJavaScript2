<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>A query language over a CSV file</title>
    <link rel="stylesheet" type="text/css" media="screen" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <style>
        .input-group{
            margin:3em 0;
        }
        .btn-file {
            position: relative;
            overflow: hidden;
        }
        input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }
    </style>
</head>
<body>
<div class="content">
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <div class="well  well-lg loadedFile">No file loaded ...</div>
            <form>
                <div class="input-group ">
                    <span class="btn btn-primary btn-file">
                        Choose CSV file <input type="file" id="yourFile">
                    </span>
                </div>
                <div class="input-group">
                    <span class="input-group-btn">
                     <button class="btn btn-default" type="submit">Go!</button>
                  </span>
                    <input type="text" class="form-control" id="formQuery" placeholder="Enter Query..." name="query">
                </div>
            </form>
        </div>

    </div>
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <table id="formTable" class="table table-bordered">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<script>
    var $ = document.querySelectorAll.bind(document);
    var $_ = document.querySelector.bind(document);
    var form = $_("form");
    var input = $_('#yourFile');
    var tableHeader = $_("thead");
    var tableBody = $_("tbody");
    var tableData = [];

    form.addEventListener("submit", function(event) {
        console.log("Query value", form.elements.query.value);
        var queryString = form.elements.query.value;
        queryString = queryString.split(' ');
        for(var i = 0,q = queryString.length; i<q; i++ ){
            if(queryString[i] === 'SHOW'){
                showQuery()
            }
        }
        event.preventDefault();
    });

    input.addEventListener("change", function(){
        if(input.files.length > 0){
            var file = input.files[0];

            $_('.loadedFile').innerHTML = "File loaded <strong>" + file.name + "</strong>";
            var reader = new FileReader();

            reader.onload = function(){
                // By lines
                tableData = this.result.split('\n');

                //TODO:remove initial table creation
                createTable(tableData, tableData.length, tableData[0].split(',').length);

            };
            reader.readAsText(file);
        }
    });

    function createTable(_lines, rows, cells){
        for(var line = 0, n = rows; line < n; line++){
            //create Row
            var newRow = tableBody.insertRow(line);
            if(line === 0) newRow = tableHeader.insertRow(line);

            //create Cells
            var rowCells = _lines[line].split(',');
            for(var cell = 0, c = cells; cell < c; cell++){
                var newCell  = newRow.insertCell(cell);
                var newText = document.createTextNode(rowCells[cell]);
                newCell.appendChild(newText);
            }
        }
    }

    function showQuery(){
        createTable(tableData, 1,
                tableData[0].split(',').length);
    }

</script>
</body>
</html>